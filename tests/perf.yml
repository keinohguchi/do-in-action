---
- name: data vis containers based on github.com/nerdalert/cloud-bandwidth
  hosts: client
  vars:
    debug: false
  gather_facts: false
  tasks:
    - name: install the pre-requisite apt packages
      apt: name={{ item }} state=present update_cache=false
      items:
        - docker.io
        - python-pip
      become: true

    - name: install python packages
      pip: name={{ item }}
      items:
        - docker-py
        - docker-compose
      become: true

    - name: clone the cloud-bandwidth git repo
      git:
        repo: https://github.com/nerdalert/cloud-bandwidth
        dest: /tmp/cloud-bandwidth
        update: yes
        ssh_opts: "-o StrictHostKeyChecking=no"
      register: git

    - name: docker-compose up the data vis containers!
      docker_service:
        project_src: /tmp/cloud-bandwidth
      register: cloud_bandwidth

    - name: debug the docker-compose up output
      debug: var=cloud_bandwidth
      when: debug|bool

- name: run iperf server container as bandwidth agent on server
  hosts: server
  vars:
    server_port: 5201
  gather_facts: false
  tasks:
    - name: install the pre-requisite apt packages
      apt: name={{ item }} state=present update_cache=false
      items:
        - docker.io
        - python-pip
      become: true

    - name: install python packages
      pip: name={{ item }}
      items:
        - docker-py
      become: true

    - name: pull networkstatic/iperf3 image
      command: docker pull networkstatic/iperf3:latest

    - name: run iperf3 container server
      docker_container:
        name: iperf3-agent
        image: networkstatic/iperf3
        ports: "{{ server_port }}:{{ server_port }}"
        command: -s
        detach: true
        state: started

- name: run iperf poller container as bandwidth poller on client
  hosts: client
  gather_facts: false
  tasks:
    - name: pull networkstatic/bandwidth-poller image
      command: docker pull networkstatic/bandwidth-poller:latest

    - name: run iperf3 bandwidth collector
      docker_container:
        name: iperf3-poller
        image: networkstatic/bandwidth-poller
        state: started
        env:
          DB_IP: 172.17.0.2
          BW_AGENT_IP: "{{ server.ipv4 }}"
          MACHINE_TYPE: digitalocean
          IPERF_SAMPLE_COUNT: 3
      register: collect
      until: false
      retries: 100
      delay: 60
